<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="style.css">

	<title>WebTransport Playground</title>
</head>
<body>

	<main>

		<header>
			<img src="/webtransport-dummy-logo.png" alt="WebTransport" width="100" />
			<h1>WebTransport Playground</h1>
		</header>

		<section>
			<div>
				TODO: add controls to connect to a server and send datagrams.

			</div>

			<aside>
				<h2>Logs</h2>
				<code id="logs"></code>
			</aside>
		</section>

		<script type="text/javascript">
			connect();

			async function connect() {
				const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

				const pubKey = Uint8Array.from('{{SERVER_PUB_KEY}}'.split(','));

				const options = (isFirefox) ? undefined : {
					// requireUnreliable: true,
					// congestionControl: "default", // "low-latency" || "throughput"

					// Firefox doesn't support "serverCertificateHashes" option yet
					serverCertificateHashes: [{
						algorithm: 'sha-256',
						value: pubKey.buffer
					}]
				};

				console.log(options);

				const wt = new WebTransport("https://localhost:4433/", options);

				wt.ready.then(() => {
					createLog("Connection ready");
				}).catch((e) => {
					createLog("Connection failed with error" + e.message, true);
				});

				wt.closed.then(() => {
					createLog("Connection closed");
				}).catch((e) => {
					createLog("Connection closed with error" + e.message, true);
				});


				// wait connection to be ready.
				console.log("Waiting for connection...");
				await wt.ready;


				console.log("Connection ready!");

				//
				// Datagram API
				//
				const datagramReader = wt.datagrams.readable.getReader();
				const datagramWriter = wt.datagrams.writable.getWriter();

				let isReaderClosed = false;
				datagramReader.closed.then(() => isReaderClosed = true);

				async function readDatagrams(reader) {
					console.log("Reading datagrams... closed?", isReaderClosed);
					while (!isReaderClosed) {
						const result = await reader.read();
						createLog("Received datagram: " + result.value);
					}
				}
				readDatagrams(datagramReader);

				//
				// Bidirectional streams
				//
				receiveBidirectional();

				async function receiveBidirectional() {
					const bds = wt.incomingBidirectionalStreams;
					const reader = bds.getReader();
					while (true) {
						const { done, value } = await reader.read();
						if (done) {
							break;
						}
						// value is an instance of WebTransportBidirectionalStream
						console.log("Received bidirectional stream", {
							readable: value.readable,
							writable: value.writable
						})
					}
				}

				// Unidirectional Stream

				// Bidirectional Stream

			}

			function sendDatagram(wt) {
			}

			const logsEl = document.querySelector("#logs");
			function createLog(message, isError = false) {
				const logEl = document.createElement("div");
				if (isError) { logEl.classList.add("error"); }
				logEl.appendChild(document.createTextNode(message));
				logsEl.appendChild(logEl);
				// force scroll to bottom
				logsEl.scrollTop = logsEl.scrollHeight;
			}

		</script>

		<footer>
			<h3>External references:</h3>
			<ul>
				<li><a href="https://web.dev/webtransport/">Using WebTransport <small>(web.dev)</small></a></li>
				<li><a href="https://www.w3.org/TR/webtransport/">W3C Working Draft <small>(w3c.org)</small></a></li>
			</ul>
		</footer>

	</main>

</body>
</html>